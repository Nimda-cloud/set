# Malware Detection and Analysis System

## Огляд

Система NIMDA тепер включає розширену функціональність для виявлення, аналізу та видалення троянів та інших шкідливих програм. Система виконує глибокий аналіз пов'язаних файлів та процесів для повного контролю над шкідливою екосистемою.

## Нові функції безпеки

### 1. Виявлення троянів (DETECT_TROJAN)
- **Опис**: Автоматичне виявлення підозрілих процесів, файлів та мережевих з'єднань
- **Дії**:
  - Сканування процесів на підозрілі патерни
  - Аналіз файлів на шкідливі розширення та назви
  - Перевірка мережевих з'єднань на підозрілі IP та порти
  - Оцінка рівня ризику та генерація рекомендацій

### 2. Ізоляція файлів (ISOLATE_FILE)
- **Опис**: Безпечна ізоляція підозрілих файлів у карантин
- **Дії**:
  - Копіювання файлу в карантинну директорію
  - Встановлення обмежувальних прав доступу (000)
  - Логування операції ізоляції
  - Збереження оригінального файлу для подальшого аналізу

### 3. Глибокий аналіз (DEEP_ANALYSIS)
- **Опис**: Комплексний аналіз структури файлу, поведінки процесів та мережевих патернів
- **Дії**:
  - Аналіз метаданих файлу (розмір, права, час модифікації)
  - Моніторинг поведінки пов'язаних процесів
  - Аналіз мережевих з'єднань
  - Збереження детального звіту аналізу

### 4. Карантин (QUARANTINE)
- **Опис**: Повна ізоляція цілі з усіма пов'язаними компонентами
- **Дії**:
  - Завершення пов'язаних процесів
  - Ізоляція пов'язаних файлів
  - Блокування мережевих з'єднань
  - Повна ізоляція від системи

### 5. Видалення шкідливого ПЗ (REMOVE_MALWARE)
- **Опис**: Повне видалення шкідливого програмного забезпечення
- **Дії**:
  - Глибокий аналіз перед видаленням
  - Видалення всіх пов'язаних файлів
  - Завершення всіх пов'язаних процесів
  - Очищення конфігураційних змін
  - Відновлення з резервної копії (якщо доступно)

### 6. Аналіз екосистеми (ANALYZE_ECOSYSTEM)
- **Опис**: Аналіз всієї шкідливої екосистеми для повного контролю
- **Дії**:
  - Пошук всіх пов'язаних файлів
  - Виявлення пов'язаних процесів
  - Аналіз мережевих з'єднань
  - Оцінка загального рівня ризику
  - Генерація комплексного звіту

## Політики безпеки

### Рівні загроз та дії

| Рівень загрози | Нові дії безпеки |
|----------------|------------------|
| LOW | - |
| MEDIUM | DETECT_TROJAN |
| HIGH | DETECT_TROJAN, DEEP_ANALYSIS |
| CRITICAL | DETECT_TROJAN, ISOLATE_FILE, ANALYZE_ECOSYSTEM |
| EMERGENCY | DETECT_TROJAN, ISOLATE_FILE, DEEP_ANALYSIS, QUARANTINE, REMOVE_MALWARE, ANALYZE_ECOSYSTEM |

## Технічні деталі

### Підозрілі патерни

#### Процеси
- Назви: trojan, virus, malware, backdoor, keylogger, spyware, rootkit, botnet, crypto, miner
- Команди: пошук підозрілих патернів у командному рядку

#### Файли
- Розширення: .exe, .bat, .cmd, .scr, .pif, .com
- Назви: пошук підозрілих патернів у назві файлу

#### Мережеві з'єднання
- Підозрілі порти: 4444, 5555, 31337, 1337, 6667, 6668, 6669
- Відомі шкідливі IP (налаштовується)
- Зовнішні з'єднання

### Карантинна система

#### Директорії
- `/tmp/nimda_quarantine` - ізольовані файли
- `/tmp/nimda_analysis` - звіти аналізу

#### Логування
- `isolation_log.json` - журнал ізоляції файлів
- `deep_analysis_*.json` - звіти глибокого аналізу
- `ecosystem_*.json` - звіти аналізу екосистеми

### Оцінка ризику

#### Алгоритм оцінки
```
Ризик = (Файли × 10) + (Процеси × 20) + (З'єднання × 15) + (Конфігурації × 25)
```

#### Рівні ризику
- **LOW**: < 20 балів
- **MEDIUM**: 20-49 балів
- **HIGH**: 50-99 балів
- **CRITICAL**: ≥ 100 балів

## Використання

### Автоматичне виявлення
Система автоматично виконує нові дії безпеки відповідно до рівня загрози:

```python
# Приклад автоматичного виконання
threat_level = analyzer.analyze_port_threat(4444, "suspicious")
analyzer.execute_actions(threat_level, target, details)
```

### Ручне використання
```python
from malware_detection import MalwareDetector

detector = MalwareDetector()

# Виявлення трояна
result = detector.detect_trojan("/path/to/suspicious/file", {})

# Ізоляція файлу
isolation = detector.isolate_file("/path/to/file", {})

# Глибокий аналіз
analysis = detector.deep_analysis("/path/to/target", {})

# Карантин
quarantine = detector.quarantine_target("/path/to/target", {})

# Видалення шкідливого ПЗ
removal = detector.remove_malware("/path/to/target", {})

# Аналіз екосистеми
ecosystem = detector.analyze_ecosystem("/path/to/target", {})
```

## Тестування

### Запуск тестів
```bash
python test_malware_detection.py
```

### Тести включають
1. **Виявлення троянів** - тестування алгоритмів виявлення
2. **Ізоляція файлів** - перевірка карантинної системи
3. **Глибокий аналіз** - тестування аналітичних функцій
4. **Аналіз екосистеми** - перевірка комплексного аналізу
5. **Карантин** - тестування повної ізоляції
6. **Видалення шкідливого ПЗ** - перевірка процедур видалення
7. **Інтеграція** - тестування інтеграції з основною системою

## Безпека

### Привілеї
- Всі операції з файлами вимагають sudo привілеїв
- Команди виконуються через `sudo -n` для автоматизації
- Перевірка прав доступу перед виконанням операцій

### Логування
- Всі операції детально логуються
- Зберігаються звіти аналізу
- Відстеження всіх змін у системі

### Відновлення
- Збереження оригінальних файлів у карантині
- Можливість відновлення з резервних копій
- Детальні звіти для аналізу

## Налаштування

### Підозрілі патерни
Можна налаштувати в `MalwareDetector`:
```python
self.suspicious_patterns = [
    'trojan', 'virus', 'malware', 'backdoor', 'keylogger',
    'spyware', 'rootkit', 'botnet', 'crypto', 'miner'
]
```

### Карантинні директорії
```python
self.quarantine_dir = "/tmp/nimda_quarantine"
self.analysis_dir = "/tmp/nimda_analysis"
```

### Підозрілі порти
```python
self.unusual_ports = [4444, 5555, 31337, 1337, 6667, 6668, 6669]
```

## Обмеження

### macOS
- Деякі операції можуть вимагати додаткових прав
- Файлова система APFS має особливості для ізоляції
- Time Machine для резервного копіювання

### Продуктивність
- Глибокий аналіз може займати час
- Сканування великої кількості файлів ресурсоємне
- Рекомендується налаштування обмежень

## Майбутні покращення

### Заплановані функції
- Інтеграція з антивірусними базами даних
- Машинне навчання для виявлення нових загроз
- Автоматичне оновлення сигнатур
- Інтеграція з хмарними сервісами безпеки
- Розширена аналітика поведінки

### Оптимізація
- Кешування результатів аналізу
- Паралельне оброблення файлів
- Оптимізація алгоритмів пошуку
- Зменшення навантаження на систему

## Підтримка

### Логи
- Перевірте `/tmp/nimda_quarantine/isolation_log.json`
- Аналіз звітів у `/tmp/nimda_analysis/`
- Системні логи для помилок

### Діагностика
```bash
# Перевірка карантинної директорії
ls -la /tmp/nimda_quarantine/

# Перегляд звітів аналізу
ls -la /tmp/nimda_analysis/

# Тестування функціональності
python test_malware_detection.py
```

## 🚀 Майбутні покращення

### Планується додати:
- Parallel file processing
- Optimization of search algorithms
- Reduction of system load

## Support

### Logs
- Check `/tmp/nimda_quarantine/isolation_log.json`
- Analyze reports in `/tmp/nimda_analysis/`
- System logs for errors

### Diagnosis
```bash
# Check quarantine directory
ls -la /tmp/nimda_quarantine/

# View analysis reports
ls -la /tmp/nimda_analysis/

# Functionality testing
python test_malware_detection.py
```

### Feedback
- Report errors via the logging system
- Request new features via GitHub Issues
- Documentation updates in README files 